<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Calendar</title>
    
    <!-- Google AdSense Main Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7127892355249348" crossorigin="anonymous"></script>

    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            /* Live Color Variables */
            --bg-off: #38761d;
            --text-off: #ffffff; 
            
            --bg-on: #ffeb3b;
            --text-on: #000000;  
            
            --bg-special: #ffffff;
            --text-special: #ff0000; 

            /* UI Colors */
            --primary: #2c3e50;
            --accent: #217346;
            --bg-body: #f4f7f6;
            --bg-card: #ffffff;
            --border-soft: #e0e0e0;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            
            --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --radius: 8px;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: #333;
            margin: 0;
            padding: 15px;
            font-size: 14px;
        }

        /* --- AD BANNER --- */
        .ad-container {
            max-width: 1400px;
            margin: 0 auto 20px auto;
            background: #e9ecef;
            border: 1px dashed #adb5bd;
            text-align: center;
            padding: 10px;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            overflow: hidden;
        }
        .ad-placeholder-text { color: #6c757d; font-style: italic; font-weight: bold; }

        /* LAYOUT CONTAINER */
        .main-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start;
        }
        
        .top-bar {
            max-width: 1400px;
            margin: 0 auto 20px auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .lang-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .lang-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* --- CARDS & SECTIONS --- */
        .section-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-soft);
        }

        .calendar-section { flex: 2; min-width: 340px; }
        .controls-section { flex: 2; min-width: 320px; }
        .sidebar-section { flex: 1; min-width: 250px; display: flex; flex-direction: column; }

        /* --- MODERN CALENDAR STYLE --- */
        #calTable {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 4px; 
            margin-top: 10px;
        }
        
        .cal-header {
            color: #666;
            font-size: 13px;
            text-transform: uppercase;
            padding-bottom: 5px;
            border: none !important;
            background: transparent !important;
            font-weight: 700;
        }

        #calBody td {
            height: 45px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.05);
            font-weight: 500;
            vertical-align: middle;
            text-align: center;
            transition: transform 0.1s;
            white-space: nowrap; 
            font-size: 13px;
            padding: 2px;
            overflow: hidden;
        }
        #calBody td:hover { transform: scale(1.02); }

        /* Dynamic Colors */
        .cell-off { background-color: var(--bg-off); color: var(--text-off); box-shadow: 0 2px 4px rgba(0,0,0,0.1); border:none !important;}
        .cell-on { background-color: var(--bg-on); color: var(--text-on); box-shadow: 0 2px 4px rgba(0,0,0,0.1); border:none !important;}
        .cell-special { 
            background-color: var(--bg-special) !important; 
            color: var(--text-special) !important; 
            font-weight: 800;
            border: 2px solid var(--text-special) !important;
        }
        .first-day-highlight { text-decoration: underline; font-size: 1.1em; }

        /* --- CONTROLS FORM STYLE --- */
        .control-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .control-group:last-child { border-bottom: none; margin-bottom: 0; }
        
        .group-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            display: block;
            font-size: 15px;
        }

        .input-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .input-wrapper { flex: 1; display: flex; flex-direction: column; min-width: 120px; }
        .input-wrapper label { font-size: 12px; color: #777; margin-bottom: 4px; font-weight: 600; }

        input[type="date"], input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: #fdfdfd;
            box-sizing: border-box;
            font-family: var(--font-family);
            color: #333;
            text-align: center;
        }
        input:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 3px rgba(33, 115, 70, 0.1);
        }

        #logicTable { width: 100%; border-collapse: collapse; font-size: 13px; }
        #logicTable thead tr { background: #f8f9fa; border-bottom: 2px solid #ddd; }
        #logicTable th { padding: 10px 5px; color: #555; font-weight: 600; text-align: center; border: none; }
        #logicTable tbody tr { border-bottom: 1px solid #eee; }
        #logicTable td { padding: 8px 4px; border: none; text-align: center; }
        #logicTable input { padding: 4px; width: 50px; border-radius: 4px; border: 1px solid #ccc; }

        .sidebar-title {
            font-size: 16px; font-weight: 700; color: var(--primary);
            margin-bottom: 15px; text-align: center;
            padding-bottom: 10px; border-bottom: 2px solid var(--accent);
            cursor: pointer;
        }
        .sidebar-title:hover { color: var(--accent); }

        .holiday-card {
            background: white; border-radius: 6px; padding: 12px; margin-bottom: 10px;
            border: 1px solid #eee; border-left: 4px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s;
        }
        .holiday-card:hover { transform: translateX(2px); }
        
        .set-btn {
            background-color: var(--accent); color: white; border: none;
            padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600;
        }

        .year-view-container {
            max-width: 1400px; margin: 20px auto; padding: 20px; background: var(--bg-card);
            border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-soft);
        }
        .year-header-controls { 
            display: flex; justify-content: center; gap: 20px; 
            margin-bottom: 20px; font-size: 20px; font-weight: bold; color: var(--primary);
        }
        .year-header-controls button {
            background: #f0f0f0; border: none; width: 30px; height: 30px; 
            border-radius: 50%; cursor: pointer; font-weight: bold;
        }
        
        .year-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        
        .month-block { 
            width: 300px; background: white; border-radius: 8px; border: 1px solid #eee; overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .month-title { 
            text-align: center; font-weight: 700; background: #f8f9fa; padding: 8px; color: #555;
            border-bottom: 1px solid #eee;
        }
        .mini-table { width: 100%; border-collapse: separate; border-spacing: 1px; padding: 5px; }
        .mini-table th { color: #999; font-size: 10px; padding: 2px; }
        .mini-table td { text-align: center; font-size: 11px; padding: 3px 0; border-radius: 3px; }

        .export-btn {
            display: block; width: 100%; padding: 14px; margin-bottom: 15px;
            background-color: #e74c3c; color: white; border: none; border-radius: 6px;
            font-size: 16px; font-weight: 600; cursor: pointer; 
            box-shadow: 0 4px 6px rgba(231, 76, 60, 0.2); transition: background 0.2s;
        }
        .export-btn:hover { background-color: #c0392b; }

        .color-settings {
            display: flex; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; 
            justify-content: space-between; align-items: center;
        }
        .color-group { display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: 600; color: #666; }
        input[type="color"] { 
            width: 36px; height: 36px; border: none; border-radius: 50%; 
            cursor: pointer; padding: 0; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .reset-colors-btn { font-size: 12px; color: #777; background: none; border: 1px solid #ddd; padding: 5px 10px; border-radius: 15px; cursor: pointer; }

        .instructions-box {
            background: #e8f5e9; padding: 15px; border-radius: 6px; 
            color: #2e7d32; font-size: 13px; margin-bottom: 15px; line-height: 1.6;
        }

        @media (max-width: 1024px) { .main-container { flex-wrap: wrap; } .sidebar-section { width: 100%; order: 3; } }
        @media (max-width: 768px) { 
            .main-container { flex-direction: column; } .controls-section { order: 1; } 
            .calendar-section { order: 2; } .sidebar-section { order: 3; } 
            #calBody td { font-size: 11px; height: 40px; padding: 1px; }
        }

        body[dir="rtl"] { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body[dir="rtl"] .holiday-card { border-left: none; border-right: 4px solid var(--accent); }
        body[dir="rtl"] .set-btn { margin-left: 0; margin-right: 8px; }

    </style>
</head>
<body dir="ltr">

    <!-- AD BANNER -->
    <div class="ad-container">
        <!-- 
           ========== INSTRUCTIONS FOR ADS ============
           The main AdSense script is already in the <head>.
           To show a specific banner here:
           1. Create a "Display Ad Unit" in your AdSense dashboard.
           2. It will provide you with an <ins> tag and a small <script> call.
           3. Paste that specific unit code below this comment.
        -->
        <span class="ad-placeholder-text">Ad Content Will Appear Here</span>
    </div>

    <div class="top-bar">
        <h2 style="margin:0; font-size: 24px;" id="appTitle">Shift Calendar</h2>
        <button class="lang-btn" onclick="toggleLanguage()">عربي / English</button>
    </div>

    <div class="main-container">

        <!-- 1. CALENDAR SECTION -->
        <div class="section-card calendar-section" id="section-calendar">
            <div style="text-align:center; font-weight:700; font-size:18px; margin-bottom:15px; color:var(--primary);" id="lblCalView">Calendar View</div>
            <table id="calTable">
                <thead><tr id="calHeaderRow"></tr></thead>
                <tbody id="calBody"></tbody>
            </table>
        </div>

        <!-- 2. CONTROLS SECTION -->
        <div class="section-card controls-section">
            
            <button class="export-btn" onclick="generateShortPDF()" id="btnExport">Export to PDF</button>

            <!-- Color Picker -->
            <div class="control-group">
                <div class="color-settings">
                    <div class="color-group"><input type="color" id="colOn" value="#ffeb3b" onchange="updateColors()"><span id="lblColorOn">On Duty</span></div>
                    <div class="color-group"><input type="color" id="colOff" value="#38761d" onchange="updateColors()"><span id="lblColorOff">Off Duty</span></div>
                    <div class="color-group"><input type="color" id="colSpec" value="#ffffff" onchange="updateColors()"><span id="lblColorSpec">Special</span></div>
                    <button class="reset-colors-btn" onclick="resetColors()" id="btnResetCol">Reset</button>
                </div>
            </div>

            <div class="instructions-box">
                <strong id="lblInstrTitle">How to use:</strong><br>
                <span id="lblInstr1">1. Select First Working Day.</span><br>
                <span id="lblInstr2">2. Set Special Dates.</span><br>
                <span id="lblInstr3">3. Adjust On/Off days below.</span>
            </div>

            <!-- Start Date Control -->
            <div class="control-group">
                <span class="group-title" id="lblFirstWork">First Working Day</span>
                <div class="input-row">
                    <div class="input-wrapper">
                        <label id="lblDateSel">Select Date</label>
                        <input type="date" id="inStartDate" onchange="calculateAll()">
                    </div>
                    <div class="input-wrapper" style="flex: 0 0 100px;">
                        <label id="lblWeekday">Weekday</label>
                        <div id="outWeekday" style="padding:8px; background:#eee; border-radius:6px; text-align:center;">...</div>
                    </div>
                </div>
            </div>

            <!-- Special Dates Control -->
            <div class="control-group">
                <span class="group-title">Special Dates</span>
                <div class="input-row" style="margin-bottom: 10px;">
                    <div class="input-wrapper">
                        <label id="lblSpec1">Date 1</label>
                        <input type="date" id="spec1" onchange="calculateAll()">
                    </div>
                    <div class="input-wrapper">
                        <label id="lblSpec2">Date 2</label>
                        <input type="date" id="spec2" onchange="calculateAll()">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-wrapper">
                        <label id="lblSpec3">Date 3</label>
                        <input type="date" id="spec3" onchange="calculateAll()">
                    </div>
                    <div class="input-wrapper">
                        <label id="lblSpec4">Date 4</label>
                        <input type="date" id="spec4" onchange="calculateAll()">
                    </div>
                </div>
            </div>

            <!-- Logic Table -->
            <div class="control-group">
                <span class="group-title">Shift Rotation</span>
                <table id="logicTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th id="lblThStart">Start</th>
                            <th id="lblThOn">On</th>
                            <th id="lblThOff">Off</th>
                            <th id="lblThEnd">End</th>
                        </tr>
                    </thead>
                    <tbody id="logicBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 3. SIDEBAR (HOLIDAYS) -->
        <div class="section-card sidebar-section" id="section-holidays">
            <div class="sidebar-title" onclick="generateFullPDF()" title="Click for Full PDF" id="lblHolidaysTitle">Islamic Holidays</div>
            <div id="islamicHolidaysList">
                <div class="loading-text" style="text-align:center; color:#999;">Loading...</div>
            </div>
            
            <div class="visit-counter">
                <span id="lblVisits">Your Visits:</span> <span class="counter-val" id="visitCountVal">0</span>
            </div>
            <div id="holiday-footer" style="font-size:10px; color:#999; text-align:center; margin-top:5px;">*Estimated dates</div>
        </div>

    </div>

    <!-- 4. YEAR VIEW -->
    <div class="year-view-container" id="section-yearview">
        <div class="year-header-controls">
            <button onclick="changeYear(-1)">&lt;</button>
            <span id="yearDisplayLabel">2025 Overview</span>
            <button onclick="changeYear(1)">&gt;</button>
        </div>
        <div class="year-grid" id="yearGrid"></div>
    </div>

<script>
    // --- DICTIONARY ---
    const i18n = {
        en: {
            appTitle: "Shift Calendar", lblCalView: "Calendar View", btnExport: "Export to PDF",
            lblColorOn: "On", lblColorOff: "Off", lblColorSpec: "Special", btnResetCol: "Reset",
            lblInstrTitle: "How to use:", lblInstr1: "1. Select First Working Day.", lblInstr2: "2. Set Special Dates.",
            lblInstr3: "3. Adjust On/Off days below.", lblFirstWork: "First Working Day", lblDateSel: "Select Date",
            lblWeekday: "Weekday", lblSpec1: "Date 1", lblSpec2: "Date 2", lblSpec3: "Date 3",
            lblSpec4: "Date 4", lblThStart: "Start", lblThOn: "On", lblThOff: "Off",
            lblThEnd: "End", lblHolidaysTitle: "Islamic Holidays", days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
            daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"], setBtn: "Set", yearOverview: "Yearly Overview",
            lblVisits: "Your Visits:"
        },
        ar: {
            appTitle: "جدول الورديات", lblCalView: "عرض التقويم", btnExport: "تصدير PDF",
            lblColorOn: "دوام", lblColorOff: "راحة", lblColorSpec: "خاص", btnResetCol: "إعادة",
            lblInstrTitle: "طريقة الاستخدام:", lblInstr1: "1. اختر تاريخ أول يوم عمل.", lblInstr2: "2. حدد التواريخ الخاصة.",
            lblInstr3: "3. عدّل أيام العمل والراحة.", lblFirstWork: "أول يوم عمل", lblDateSel: "اختر التاريخ",
            lblWeekday: "اليوم", lblSpec1: "تاريخ 1", lblSpec2: "تاريخ 2", lblSpec3: "تاريخ 3",
            lblSpec4: "تاريخ 4", lblThStart: "البداية", lblThOn: "عمل", lblThOff: "راحة",
            lblThEnd: "النهاية", lblHolidaysTitle: "المناسبات الإسلامية", days: ["الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"],
            daysShort: ["أحد", "اثنين", "ثلاثاء", "أربعاء", "خميس", "جمعة", "سبت"], setBtn: "تحديد", yearOverview: "نظرة سنوية",
            lblVisits: "عدد زياراتك:"
        }
    };

    let currentLang = 'en';
    let rowsState = Array.from({length: 20}, () => ({ on: 14, off: 14 }));
    let currentViewYear = 2025;
    let nextSpecialSlot = 1;

    let globalOnDutySet = new Set(); 

    function init() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('inStartDate').value = `${yyyy}-${mm}-${dd}`;
        
        calculateAll();
        fetchIslamicHolidays(yyyy);
        updateColors(); 
        
        let visits = localStorage.getItem('shiftCalendarVisits') || 0;
        visits++;
        localStorage.setItem('shiftCalendarVisits', visits);
        document.getElementById('visitCountVal').innerText = visits;
    }

    function toggleLanguage() {
        currentLang = (currentLang === 'en') ? 'ar' : 'en';
        document.body.dir = (currentLang === 'ar') ? 'rtl' : 'ltr';
        for (let key in i18n[currentLang]) {
            if (Array.isArray(i18n[currentLang][key])) continue; 
            let el = document.getElementById(key);
            if (el) el.innerText = i18n[currentLang][key];
        }
        calculateAll();
        let yr = parseInt(document.getElementById('inStartDate').value.split('-')[0]);
        fetchIslamicHolidays(yr);
    }

    function getContrastColor(hexColor) {
        const r = parseInt(hexColor.substr(1, 2), 16);
        const g = parseInt(hexColor.substr(3, 2), 16);
        const b = parseInt(hexColor.substr(5, 2), 16);
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? '#000000' : '#ffffff';
    }

    function updateColors() {
        let r = document.querySelector(':root');
        let cOn = document.getElementById('colOn').value;
        let cOff = document.getElementById('colOff').value;
        let cSpec = document.getElementById('colSpec').value;

        r.style.setProperty('--bg-on', cOn);
        r.style.setProperty('--text-on', getContrastColor(cOn));
        r.style.setProperty('--bg-off', cOff);
        r.style.setProperty('--text-off', getContrastColor(cOff));
        r.style.setProperty('--bg-special', cSpec);
        
        let specLum = getContrastColor(cSpec);
        if (specLum === '#000000') {
            r.style.setProperty('--text-special', '#ff0000');
        } else {
            r.style.setProperty('--text-special', '#ffffff');
        }
    }

    function resetColors() {
        document.getElementById('colOn').value = "#ffeb3b";
        document.getElementById('colOff').value = "#38761d";
        document.getElementById('colSpec').value = "#ffffff";
        updateColors();
    }

    function calculateAll() {
        let dateVal = document.getElementById('inStartDate').value;
        if (!dateVal) return;
        
        let parts = dateVal.split('-');
        let startDate = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));

        if (!document.getElementById('yearGrid').hasChildNodes()) {
            currentViewYear = startDate.getFullYear();
        }

        document.getElementById('outWeekday').innerText = i18n[currentLang].days[startDate.getDay()];

        let logicBody = document.getElementById('logicBody');
        logicBody.innerHTML = "";
        
        globalOnDutySet.clear();
        
        let currentStart = new Date(startDate);

        for (let i = 0; i < rowsState.length; i++) {
            let rowData = rowsState[i];
            
            let tempDate = new Date(currentStart);
            for (let d = 0; d < rowData.on; d++) {
                globalOnDutySet.add(toISODate(tempDate));
                tempDate.setDate(tempDate.getDate() + 1);
            }

            let workEnd = new Date(currentStart);
            workEnd.setDate(workEnd.getDate() + rowData.on - 1);
            
            let cycleEnd = new Date(currentStart);
            cycleEnd.setDate(cycleEnd.getDate() + rowData.on + rowData.off - 1);

            logicBody.innerHTML += `
                <tr>
                    <td style="color:var(--accent); font-weight:bold;">${i + 1}</td>
                    <td>${formatDate(currentStart)}</td>
                    <td><input type="number" inputmode="numeric" value="${rowData.on}" onfocus="this.select()" onchange="updateTable(${i}, 'on', this.value)"></td>
                    <td><input type="number" inputmode="numeric" value="${rowData.off}" onfocus="this.select()" onchange="updateTable(${i}, 'off', this.value)"></td>
                    <td>${formatDate(cycleEnd)}</td>
                </tr>`;
            
            currentStart = new Date(cycleEnd);
            currentStart.setDate(currentStart.getDate() + 1);
        }

        buildCalendar(startDate);
        updateYearView();
    }

    function updateTable(idx, type, val) {
        let n = parseInt(val) || 0;
        for (let i = idx; i < rowsState.length; i++) {
            if (type === 'on') rowsState[i].on = n; else rowsState[i].off = n;
        }
        calculateAll();
    }

    function buildCalendar(firstDate) {
        let thead = document.getElementById('calHeaderRow');
        let tbody = document.getElementById('calBody');
        thead.innerHTML = ""; tbody.innerHTML = "";

        let specials = getSpecialDates();
        let daysList = i18n[currentLang].daysShort;
        let startDayIdx = firstDate.getDay();

        for (let i = 0; i < 7; i++) {
            thead.innerHTML += `<td class="cal-header">${daysList[(startDayIdx + i) % 7]}</td>`;
        }

        let gridDate = new Date(firstDate);
        for (let r = 0; r < 60; r++) {
            let tr = document.createElement('tr');
            for (let c = 0; c < 7; c++) {
                let cell = document.createElement('td');
                let dayNum = gridDate.getDate();
                let mShort = gridDate.toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'default', { month: 'short' });
                cell.innerText = `${dayNum}-${mShort}`;
                
                applyColorLogic(cell, gridDate, specials);
                if (dayNum === 1) cell.classList.add('first-day-highlight');
                
                tr.appendChild(cell);
                gridDate.setDate(gridDate.getDate() + 1);
            }
            tbody.appendChild(tr);
        }
    }

    function createMonthElement(year, month) {
        let monthDate = new Date(year, month, 1);
        let specials = getSpecialDates();

        let block = document.createElement('div');
        block.className = "month-block";
        
        let title = document.createElement('div');
        title.className = "month-title";
        title.innerText = monthDate.toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'default', { month: 'long', year: 'numeric' });
        block.appendChild(title);

        let table = document.createElement('table');
        table.className = "mini-table";
        let trH = document.createElement('tr');
        let miniD = currentLang === 'ar' ? ["ح","ن","ث","ر","خ","ج","س"] : ["S","M","T","W","T","F","S"];
        miniD.forEach(d => {
            let th = document.createElement('th'); th.innerText = d; th.className="mini-day-header"; trH.appendChild(th);
        });
        table.appendChild(trH);

        let startDay = monthDate.getDay();
        let daysInM = new Date(year, month+1, 0).getDate();
        let tr = document.createElement('tr');
        
        for(let i=0; i<startDay; i++) tr.appendChild(document.createElement('td'));

        for(let d=1; d<=daysInM; d++) {
            if(tr.children.length === 7) { table.appendChild(tr); tr = document.createElement('tr'); }
            let cellDate = new Date(year, month, d);
            let td = document.createElement('td');
            td.innerText = d;
            applyColorLogic(td, cellDate, specials);
            tr.appendChild(td);
        }
        while(tr.children.length > 0 && tr.children.length < 7) tr.appendChild(document.createElement('td'));
        if(tr.children.length > 0) table.appendChild(tr);

        block.appendChild(table);
        return block;
    }

    function updateYearView() {
        document.getElementById('yearDisplayLabel').innerText = `${currentViewYear} ${i18n[currentLang].yearOverview}`;
        let container = document.getElementById('yearGrid');
        container.innerHTML = "";
        
        for (let m = 0; m < 12; m++) {
            container.appendChild(createMonthElement(currentViewYear, m));
        }
    }

    function changeYear(d) { currentViewYear += d; updateYearView(); }

    function applyColorLogic(el, date, specials) {
        let iso = toISODate(date);
        el.style.boxShadow = ''; 
        
        if (specials.includes(iso)) { 
            el.className = "cell-special"; 
            return; 
        }
        
        if (globalOnDutySet.has(iso)) {
            el.className = "cell-on";
            return;
        }

        el.className = "cell-off";
    }

    function getSpecialDates() {
        return ['spec1','spec2','spec3','spec4'].map(id => document.getElementById(id).value).filter(d=>d);
    }
    
    function formatDate(d) { return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
    function toISODate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

    async function fetchIslamicHolidays(year) {
        let list = document.getElementById('islamicHolidaysList');
        let holidays = [];
        try {
            for (let y of [year, year+1]) {
                let hBase = y - 579;
                for (let hY of [hBase, hBase+1]) {
                    let ram = await hToG(1,9,hY,"Ramadan Starts","رمضان");
                    if(ram) holidays.push(ram);
                    let fit = await hToG(1,10,hY,"Eid Al-Fitr","عيد الفطر");
                    if(fit) holidays.push(fit);
                    let adh = await hToG(10,12,hY,"Eid Al-Adha","عيد الأضحى");
                    if(adh) holidays.push(adh);
                }
            }
            holidays.sort((a,b)=>a.raw-b.raw);
            let cut = new Date(); cut.setDate(cut.getDate()-7);
            holidays = holidays.filter(h=>h.raw >= cut);
            holidays = holidays.filter((h,i,s)=> i===s.findIndex(t=>t.dateStr===h.dateStr));
            
            list.innerHTML = "";
            holidays.slice(0,6).forEach(h => {
                let dIso = toISODate(h.raw);
                let name = currentLang === 'ar' ? h.nameAr : h.nameEn;
                list.innerHTML += `
                <div class="holiday-card">
                    <div style="flex:1">
                        <div style="font-weight:700;color:var(--accent);">${name}</div>
                        <div style="font-size:12px;color:#555">${h.dateStr}</div>
                    </div>
                    <button class="set-btn" onclick="setSpecial('${dIso}')">${i18n[currentLang].setBtn}</button>
                </div>`;
            });
        } catch(e) { list.innerHTML = "Error loading holidays."; }
    }

    async function hToG(d,m,y,nEn,nAr) {
        let r = await fetch(`https://api.aladhan.com/v1/hToG?date=${String(d).padStart(2,'0')}-${String(m).padStart(2,'0')}-${y}`);
        let j = await r.json();
        if(j.code===200) {
            let g = j.data.gregorian;
            return { raw: new Date(g.year, g.month.number-1, g.day), dateStr: g.date, nameEn: nEn, nameAr: nAr };
        }
    }

    function setSpecial(val) {
        document.getElementById(`spec${nextSpecialSlot}`).value = val;
        nextSpecialSlot = (nextSpecialSlot % 4) + 1; 
        calculateAll();
    }

    function generateShortPDF() { createPDF(true); }
    function generateFullPDF() { createPDF(false); }

    function createPDF(isShort) {
        let temp = document.createElement('div');
        temp.style.width = '700px'; temp.style.background = 'white'; temp.style.padding = '20px';
        
        temp.style.fontFamily = 'Segoe UI, Arial, sans-serif';

        let calClone = document.getElementById('section-calendar').cloneNode(true);
        calClone.style.flex = 'none'; calClone.style.width = '100%'; calClone.style.boxShadow='none';
        calClone.style.marginBottom = '20px'; calClone.style.border='none';
        
        if (isShort) {
            let tbody = calClone.querySelector('tbody');
            while(tbody.children.length > 15) { tbody.removeChild(tbody.lastChild); }
            let title = calClone.querySelector('div');
            title.innerText = currentLang==='ar' ? "ملخص 3 أشهر" : "3-Month Summary";
        }
        temp.appendChild(calClone);

        if (isShort) {
            let summaryGrid = document.createElement('div');
            summaryGrid.style.display = 'flex'; 
            summaryGrid.style.justifyContent = 'space-between';
            summaryGrid.style.marginTop = '20px';

            let val = document.getElementById('inStartDate').value;
            let parts = val.split('-');
            let startY = parseInt(parts[0]);
            let startM = parseInt(parts[1]) - 1; 

            for (let i = 0; i < 3; i++) {
                let block = createMonthElement(startY, startM + i);
                block.style.width = '32%'; 
                block.style.fontSize = '10px';
                block.style.boxShadow = 'none';
                block.style.border = '1px solid #ddd';
                summaryGrid.appendChild(block);
            }
            temp.appendChild(summaryGrid);
        } else {
            let yearClone = document.getElementById('section-yearview').cloneNode(true);
            yearClone.style.boxShadow='none'; yearClone.style.marginTop='20px'; yearClone.style.border='none';
            yearClone.querySelectorAll('button').forEach(b=>b.remove());
            
            let grid = yearClone.querySelector('.year-grid');
            grid.style.display = 'flex'; 
            grid.style.flexWrap = 'wrap'; 
            grid.style.justifyContent = 'center';
            grid.style.gap = '10px';
            
            grid.querySelectorAll('.month-block').forEach(b => { 
                b.style.width = '30%'; 
                b.style.fontSize = '10px'; 
                b.style.margin = '5px';
                b.style.boxShadow = 'none';
                b.style.border = '1px solid #ddd';
            });
            temp.appendChild(yearClone);

            let holClone = document.getElementById('section-holidays').cloneNode(true);
            holClone.style.boxShadow='none'; holClone.style.border='none'; holClone.style.marginTop='20px';
            holClone.querySelectorAll('button').forEach(b=>b.remove());
            let cnt = holClone.querySelector('.visit-counter');
            if(cnt) cnt.remove();
            temp.appendChild(holClone);
        }

        let overlay = document.createElement('div');
        overlay.style.position='fixed'; overlay.style.top='0'; overlay.style.zIndex='-9999'; overlay.style.opacity='0';
        overlay.appendChild(temp); document.body.appendChild(overlay);

        const opt = {
            margin: 0.2, filename: isShort ? 'Shift_Summary.pdf' : 'Full_Calendar.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: 'avoid-all' }
        };

        html2pdf().set(opt).from(temp).save().then(() => document.body.removeChild(overlay));
    }

    window.onload = init;

</script>
</body>
</html>