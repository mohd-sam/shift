<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Calendar</title>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            /* Default Colors */
            --bg-off: #38761d;
            --text-off: #ffffff; /* Calculated automatically */
            
            --bg-on: #ffeb3b;
            --text-on: #000000;  /* Calculated automatically */
            
            --bg-special: #ffffff;
            --text-special: #ff0000; /* Calculated automatically */

            --header-gold: #ffd966;
            --header-grey: #e7e6e6;
            --header-red: #ff6464;
            --index-green: #38761d;
            
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --sidebar-bg: #f8f9fa;
        }

        body {
            font-family: var(--font-family);
            background-color: #fcfcfc;
            margin: 0;
            padding: 10px;
            font-size: 14px;
        }

        /* LAYOUT CONTAINER */
        .main-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .top-bar {
            max-width: 1400px;
            margin: 0 auto 10px auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lang-btn {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        @media (max-width: 1024px) {
            .main-container { flex-wrap: wrap; }
            .sidebar-section { width: 100%; order: 3; }
        }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .controls-section { order: 1; }
            .calendar-section { order: 2; }
            .sidebar-section { order: 3; }
        }

        /* SECTIONS */
        .calendar-section, .controls-section {
            flex: 2;
            min-width: 300px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 5px;
            border-radius: 4px;
        }

        .controls-section { padding: 10px; }

        .sidebar-section {
            flex: 1;
            min-width: 280px;
            background: var(--sidebar-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }
        th, td { border: 1px solid #a0a0a0; padding: 4px 2px; text-align: center; height: 24px; }

        input {
            width: 90%; border: none; text-align: center;
            font-family: var(--font-family); font-size: 14px;
            background: rgba(255,255,255,0.5);
        }
        input:focus { outline: 2px solid #217346; background: white; }
        
        /* DATE INPUT HACK for DD-MM-YYYY format visual */
        .date-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .date-display {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-input-hidden {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0; /* Hidden but clickable */
            cursor: pointer;
        }

        .header-grey { background-color: var(--header-grey); font-weight: bold; }
        .header-gold { background-color: var(--header-gold); font-weight: bold; }
        .header-red { background-color: var(--header-red); color: white; font-weight: bold; }
        .index-green { background-color: var(--index-green); color: white; font-weight: bold; }
        .calc-cell { background-color: #f3f3f3; color: #333; }
        .cal-header { background-color: var(--header-grey); font-weight: bold; }

        /* Dynamic Text Colors applied here */
        .cell-off { background-color: var(--bg-off); color: var(--text-off); }
        .cell-on { background-color: var(--bg-on); color: var(--text-on); }
        .cell-special { background-color: var(--bg-special) !important; color: var(--text-special) !important; font-weight: bold; }

        .first-day-highlight { font-weight: bold !important; text-decoration: underline; }

        .color-settings {
            display: flex; gap: 15px; margin-bottom: 15px; padding: 10px;
            background: #f0f0f0; border-radius: 4px; align-items: center; justify-content: space-around;
        }
        .color-group { display: flex; align-items: center; gap: 5px; font-size: 12px; font-weight: bold; }
        input[type="color"] { width: 30px; height: 30px; padding: 0; border: 1px solid #ccc; cursor: pointer; }
        .reset-colors-btn { font-size: 11px; padding: 5px; cursor: pointer; }

        .export-btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 10px;
            background-color: #d9534f; color: white; border: none; border-radius: 5px;
            font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .export-btn:hover { background-color: #c9302c; }

        .sidebar-title {
            font-size: 16px; font-weight: bold; color: #2c3e50;
            margin-bottom: 15px; text-align: center;
            border-bottom: 2px solid #217346; padding-bottom: 5px; cursor: help;
        }

        .holiday-card {
            background: white; border-left: 4px solid #217346;
            padding: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .set-btn {
            background-color: #217346; color: white; border: none;
            padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;
        }

        .year-view-container {
            max-width: 1400px; margin: 20px auto; background: white;
            padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 4px;
        }
        .year-header-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; font-size: 18px; font-weight: bold; }
        .year-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .month-block { width: 280px; border: 1px solid #ccc; padding: 5px; }
        .month-title { text-align: center; font-weight: bold; background: var(--header-grey); padding: 3px; }
        .mini-table { font-size: 11px; width: 100%; }
        .mini-table td, .mini-table th { border: 1px solid #eee; height: 18px; padding: 0; }
        .mini-day-header { background: #f0f0f0; }

        body[dir="rtl"] { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body[dir="rtl"] .holiday-card { border-left: none; border-right: 4px solid #217346; }
        body[dir="rtl"] .set-btn { margin-left: 0; margin-right: 8px; }

    </style>
</head>
<body dir="ltr">

    <div class="top-bar">
        <h2 style="margin:0" id="appTitle">Shift Calendar</h2>
        <button class="lang-btn" onclick="toggleLanguage()">عربي / English</button>
    </div>

    <div class="main-container">

        <!-- CALENDAR -->
        <div class="calendar-section" id="section-calendar">
            <div style="text-align:center; font-weight:bold; padding:5px; margin-bottom:5px;" id="lblCalView">Calendar View</div>
            <table id="calTable">
                <thead><tr id="calHeaderRow"></tr></thead>
                <tbody id="calBody"></tbody>
            </table>
        </div>

        <!-- CONTROLS -->
        <div class="controls-section">
            
            <button class="export-btn" onclick="generateShortPDF()" id="btnExport">Export 3-Month Summary</button>

            <!-- COLORS & CONTRAST -->
            <div class="color-settings">
                <div class="color-group">
                    <span id="lblColorOn">On Duty</span>
                    <input type="color" id="colOn" value="#ffeb3b" onchange="updateColors()">
                </div>
                <div class="color-group">
                    <span id="lblColorOff">Off Duty</span>
                    <input type="color" id="colOff" value="#38761d" onchange="updateColors()">
                </div>
                <div class="color-group">
                    <span id="lblColorSpec">Special</span>
                    <input type="color" id="colSpec" value="#ffffff" onchange="updateColors()">
                </div>
                <button class="reset-colors-btn" onclick="resetColors()" id="btnResetCol">Reset</button>
            </div>

            <!-- INSTRUCTIONS -->
            <div class="instructions-box" style="background:#e8f5e9; padding:10px; border:1px solid green; margin-bottom:10px;">
                <strong id="lblInstrTitle">How to use:</strong><br>
                <span id="lblInstr1">1. Select First Working Day.</span><br>
                <span id="lblInstr2">2. Set Special Dates.</span><br>
                <span id="lblInstr3">3. Adjust On/Off days below.</span>
            </div>

            <!-- START DATE (VISUAL HACK FOR DD-MM-YYYY) -->
            <table>
                <tr><td colspan="4" class="header-grey" id="lblFirstWork">First Working Day</td></tr>
                <tr>
                    <td colspan="3" class="header-gold" id="lblDateSel">Date Selection</td>
                    <td class="header-gold" style="width:25%" id="lblWeekday">Weekday</td>
                </tr>
                <tr>
                    <td colspan="3" style="padding:0; position:relative; height:35px;">
                        <div class="date-container">
                            <!-- Visual Display -->
                            <div id="visualDateDisplay" class="date-display">DD-MM-YYYY</div>
                            <!-- Hidden Picker -->
                            <input type="date" id="inStartDate" class="date-input-hidden" onchange="handleDateChange()">
                        </div>
                    </td>
                    <td class="calc-cell" id="outWeekday">...</td>
                </tr>
            </table>

            <!-- SPECIAL DATES -->
            <table>
                <tr>
                    <td class="header-red" id="lblSpec1">Special Date 1</td>
                    <td><input type="date" id="spec1" onchange="calculateAll()"></td>
                    <td class="header-red" id="lblSpec2">Special Date 2</td>
                    <td><input type="date" id="spec2" onchange="calculateAll()"></td>
                </tr>
                <tr>
                    <td class="header-red" id="lblSpec3">Special Date 3</td>
                    <td><input type="date" id="spec3" onchange="calculateAll()"></td>
                    <td class="header-red" id="lblSpec4">Special Date 4</td>
                    <td><input type="date" id="spec4" onchange="calculateAll()"></td>
                </tr>
            </table>

            <!-- LOGIC TABLE -->
            <table id="logicTable">
                <thead>
                    <tr>
                        <td class="index-green">#</td>
                        <td class="header-gold" id="lblThStart">On Duty Start</td>
                        <td class="header-gold" id="lblThOn">On Days</td>
                        <td class="header-gold" id="lblThOff">Off Days</td>
                        <td class="header-gold" id="lblThEnd">End Date</td>
                    </tr>
                </thead>
                <tbody id="logicBody"></tbody>
            </table>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar-section" id="section-holidays">
            <div class="sidebar-title" onclick="generateFullPDF()" title="Click for Full PDF" id="lblHolidaysTitle">Islamic Holidays</div>
            <div id="islamicHolidaysList">
                <div class="loading-text">Loading...</div>
            </div>
            <div id="holiday-footer" style="font-size:10px; color:#999; text-align:center; margin-top:10px;">*Estimated dates</div>
        </div>

    </div>

    <!-- YEAR VIEW -->
    <div class="year-view-container" id="section-yearview">
        <div class="year-header-controls">
            <button onclick="changeYear(-1)">&lt;</button>
            <span id="yearDisplayLabel">2025 Overview</span>
            <button onclick="changeYear(1)">&gt;</button>
        </div>
        <div class="year-grid" id="yearGrid"></div>
    </div>

<script>
    // --- DICTIONARY ---
    const i18n = {
        en: {
            appTitle: "Shift Calendar", lblCalView: "Calendar View", btnExport: "Export 3-Month Summary",
            lblColorOn: "On Duty", lblColorOff: "Off Duty", lblColorSpec: "Special", btnResetCol: "Reset",
            lblInstrTitle: "How to use:", lblInstr1: "1. Select First Working Day.", lblInstr2: "2. Set Special Dates.",
            lblInstr3: "3. Adjust On/Off days below.", lblFirstWork: "First Working Day", lblDateSel: "Date Selection",
            lblWeekday: "Weekday", lblSpec1: "Special Date 1", lblSpec2: "Special Date 2", lblSpec3: "Special Date 3",
            lblSpec4: "Special Date 4", lblThStart: "On Duty Start", lblThOn: "On Days", lblThOff: "Off Days",
            lblThEnd: "End Date", lblHolidaysTitle: "Islamic Holidays", days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
            daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"], setBtn: "Set", yearOverview: "Yearly Overview"
        },
        ar: {
            appTitle: "جدول الورديات", lblCalView: "عرض التقويم", btnExport: "تصدير ملخص 3 أشهر",
            lblColorOn: "دوام", lblColorOff: "راحة", lblColorSpec: "خاص", btnResetCol: "إعادة ضبط",
            lblInstrTitle: "طريقة الاستخدام:", lblInstr1: "1. اختر تاريخ أول يوم عمل.", lblInstr2: "2. حدد التواريخ الخاصة.",
            lblInstr3: "3. عدّل أيام العمل والراحة في الجدول.", lblFirstWork: "أول يوم عمل", lblDateSel: "تاريخ البداية",
            lblWeekday: "اليوم", lblSpec1: "تاريخ خاص 1", lblSpec2: "تاريخ خاص 2", lblSpec3: "تاريخ خاص 3",
            lblSpec4: "تاريخ خاص 4", lblThStart: "بداية الدوام", lblThOn: "أيام العمل", lblThOff: "أيام الراحة",
            lblThEnd: "نهاية الدورة", lblHolidaysTitle: "المناسبات الإسلامية", days: ["الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"],
            daysShort: ["أحد", "اثنين", "ثلاثاء", "أربعاء", "خميس", "جمعة", "سبت"], setBtn: "تحديد", yearOverview: "نظرة سنوية"
        }
    };

    let currentLang = 'en';
    let rowsState = Array.from({length: 20}, () => ({ on: 14, off: 14 }));
    let globalRotations = [];
    let currentViewYear = 2025;
    let nextSpecialSlot = 1;

    function init() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('inStartDate').value = `${yyyy}-${mm}-${dd}`;
        handleDateChange(); // Updates visual display and calcs
        fetchIslamicHolidays(yyyy);
        updateColors(); // Initialize contrast
    }

    function toggleLanguage() {
        currentLang = (currentLang === 'en') ? 'ar' : 'en';
        document.body.dir = (currentLang === 'ar') ? 'rtl' : 'ltr';
        for (let key in i18n[currentLang]) {
            if (Array.isArray(i18n[currentLang][key])) continue; 
            let el = document.getElementById(key);
            if (el) el.innerText = i18n[currentLang][key];
        }
        calculateAll();
        let yr = parseInt(document.getElementById('inStartDate').value.split('-')[0]);
        fetchIslamicHolidays(yr);
    }

    // --- CONTRAST & COLOR LOGIC ---
    function getContrastColor(hexColor) {
        // Convert hex to RGB
        const r = parseInt(hexColor.substr(1, 2), 16);
        const g = parseInt(hexColor.substr(3, 2), 16);
        const b = parseInt(hexColor.substr(5, 2), 16);
        // Calculate YIQ luminance
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        // Returns black for light colors, white for dark colors
        return (yiq >= 128) ? '#000000' : '#ffffff';
    }

    function updateColors() {
        let r = document.querySelector(':root');
        let cOn = document.getElementById('colOn').value;
        let cOff = document.getElementById('colOff').value;
        let cSpec = document.getElementById('colSpec').value;

        r.style.setProperty('--bg-on', cOn);
        r.style.setProperty('--text-on', getContrastColor(cOn));

        r.style.setProperty('--bg-off', cOff);
        r.style.setProperty('--text-off', getContrastColor(cOff));

        r.style.setProperty('--bg-special', cSpec);
        // Special logic: if user picks white, allow red text. If dark, white text.
        // But user previously wanted Red Text. 
        // We will stick to the contrast rule: if dark BG -> White text. If Light BG -> Red Text (to keep the "Special" feel).
        // Let's check luminance.
        let specLum = getContrastColor(cSpec); // returns black or white
        if (specLum === '#000000') {
            // Light background -> Keep Red Text
            r.style.setProperty('--text-special', '#ff0000');
        } else {
            // Dark background -> White Text
            r.style.setProperty('--text-special', '#ffffff');
        }
    }

    function resetColors() {
        document.getElementById('colOn').value = "#ffeb3b";
        document.getElementById('colOff').value = "#38761d";
        document.getElementById('colSpec').value = "#ffffff";
        updateColors();
    }

    // --- VISUAL DATE HANDLING ---
    function handleDateChange() {
        let val = document.getElementById('inStartDate').value;
        if (!val) return;
        let parts = val.split('-');
        // Display as DD-MM-YYYY
        document.getElementById('visualDateDisplay').innerText = `${parts[2]}-${parts[1]}-${parts[0]}`;
        calculateAll();
    }

    // --- CALCULATION ---
    function calculateAll() {
        let dateVal = document.getElementById('inStartDate').value;
        if (!dateVal) return;
        
        let parts = dateVal.split('-');
        let startDate = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));

        if (!document.getElementById('yearGrid').hasChildNodes()) {
            currentViewYear = startDate.getFullYear();
        }

        document.getElementById('outWeekday').innerText = i18n[currentLang].days[startDate.getDay()];

        let logicBody = document.getElementById('logicBody');
        logicBody.innerHTML = "";
        globalRotations = [];
        let currentStart = new Date(startDate);

        for (let i = 0; i < rowsState.length; i++) {
            let rowData = rowsState[i];
            let workEnd = new Date(currentStart);
            workEnd.setDate(currentStart.getDate() + rowData.on - 1);
            let cycleEnd = new Date(currentStart);
            cycleEnd.setDate(currentStart.getDate() + rowData.on + rowData.off - 1);

            globalRotations.push({ start: new Date(currentStart), workEnd: new Date(workEnd) });

            logicBody.innerHTML += `
                <tr>
                    <td class="index-green">${i + 1}</td>
                    <td>${formatDate(currentStart)}</td>
                    <td><input type="number" inputmode="numeric" value="${rowData.on}" onfocus="this.select()" onchange="updateTable(${i}, 'on', this.value)"></td>
                    <td><input type="number" inputmode="numeric" value="${rowData.off}" onfocus="this.select()" onchange="updateTable(${i}, 'off', this.value)"></td>
                    <td>${formatDate(cycleEnd)}</td>
                </tr>`;
            
            currentStart = new Date(cycleEnd);
            currentStart.setDate(currentStart.getDate() + 1);
        }

        buildCalendar(startDate);
        updateYearView();
    }

    function updateTable(idx, type, val) {
        let n = parseInt(val) || 0;
        for (let i = idx; i < rowsState.length; i++) {
            if (type === 'on') rowsState[i].on = n; else rowsState[i].off = n;
        }
        calculateAll();
    }

    function buildCalendar(firstDate) {
        let thead = document.getElementById('calHeaderRow');
        let tbody = document.getElementById('calBody');
        thead.innerHTML = ""; tbody.innerHTML = "";

        let specials = getSpecialDates();
        let daysList = i18n[currentLang].daysShort;
        let startDayIdx = firstDate.getDay();

        for (let i = 0; i < 7; i++) {
            thead.innerHTML += `<td class="cal-header">${daysList[(startDayIdx + i) % 7]}</td>`;
        }

        let gridDate = new Date(firstDate);
        for (let r = 0; r < 60; r++) {
            let tr = document.createElement('tr');
            for (let c = 0; c < 7; c++) {
                let cell = document.createElement('td');
                let dayNum = gridDate.getDate();
                let mShort = gridDate.toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'default', { month: 'short' });
                cell.innerText = `${dayNum}-${mShort}`;
                
                applyColorLogic(cell, gridDate, specials);
                if (dayNum === 1) cell.classList.add('first-day-highlight');
                
                tr.appendChild(cell);
                gridDate.setDate(gridDate.getDate() + 1);
            }
            tbody.appendChild(tr);
        }
    }

    function updateYearView() {
        document.getElementById('yearDisplayLabel').innerText = `${currentViewYear} ${i18n[currentLang].yearOverview}`;
        let container = document.getElementById('yearGrid');
        container.innerHTML = "";
        let specials = getSpecialDates();

        for (let m = 0; m < 12; m++) {
            let monthDate = new Date(currentViewYear, m, 1);
            let block = document.createElement('div');
            block.className = "month-block";
            
            let title = document.createElement('div');
            title.className = "month-title";
            title.innerText = monthDate.toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'default', { month: 'long' });
            block.appendChild(title);

            let table = document.createElement('table');
            table.className = "mini-table";
            let trH = document.createElement('tr');
            let miniD = currentLang === 'ar' ? ["ح","ن","ث","ر","خ","ج","س"] : ["S","M","T","W","T","F","S"];
            miniD.forEach(d => {
                let th = document.createElement('th'); th.innerText = d; th.className="mini-day-header"; trH.appendChild(th);
            });
            table.appendChild(trH);

            let startDay = monthDate.getDay();
            let daysInM = new Date(currentViewYear, m+1, 0).getDate();
            let tr = document.createElement('tr');
            
            for(let i=0; i<startDay; i++) tr.appendChild(document.createElement('td'));

            for(let d=1; d<=daysInM; d++) {
                if(tr.children.length === 7) { table.appendChild(tr); tr = document.createElement('tr'); }
                let cellDate = new Date(currentViewYear, m, d);
                let td = document.createElement('td');
                td.innerText = d;
                applyColorLogic(td, cellDate, specials);
                tr.appendChild(td);
            }
            while(tr.children.length > 0 && tr.children.length < 7) tr.appendChild(document.createElement('td'));
            if(tr.children.length > 0) table.appendChild(tr);

            block.appendChild(table);
            container.appendChild(block);
        }
    }

    function changeYear(d) { currentViewYear += d; updateYearView(); }

    function applyColorLogic(el, date, specials) {
        let iso = toISODate(date);
        let time = date.getTime();
        if (specials.includes(iso)) { el.className = "cell-special"; return; }
        
        for(let rot of globalRotations) {
            if (time >= rot.start.getTime() && time <= rot.workEnd.getTime()) {
                el.className = "cell-on"; return;
            }
        }
        el.className = "cell-off";
    }

    function getSpecialDates() {
        return ['spec1','spec2','spec3','spec4'].map(id => document.getElementById(id).value).filter(d=>d);
    }
    
    function formatDate(d) { return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
    function toISODate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

    async function fetchIslamicHolidays(year) {
        let list = document.getElementById('islamicHolidaysList');
        let holidays = [];
        try {
            for (let y of [year, year+1]) {
                let hBase = y - 579;
                for (let hY of [hBase, hBase+1]) {
                    let ram = await hToG(1,9,hY,"Ramadan Starts","رمضان");
                    if(ram) holidays.push(ram);
                    let fit = await hToG(1,10,hY,"Eid Al-Fitr","عيد الفطر");
                    if(fit) holidays.push(fit);
                    let adh = await hToG(10,12,hY,"Eid Al-Adha","عيد الأضحى");
                    if(adh) holidays.push(adh);
                }
            }
            holidays.sort((a,b)=>a.raw-b.raw);
            let cut = new Date(); cut.setDate(cut.getDate()-7);
            holidays = holidays.filter(h=>h.raw >= cut);
            holidays = holidays.filter((h,i,s)=> i===s.findIndex(t=>t.dateStr===h.dateStr));
            
            list.innerHTML = "";
            holidays.slice(0,6).forEach(h => {
                let dIso = toISODate(h.raw);
                let name = currentLang === 'ar' ? h.nameAr : h.nameEn;
                list.innerHTML += `
                <div class="holiday-card">
                    <div style="flex:1">
                        <div style="font-weight:bold;color:#217346">${name}</div>
                        <div style="font-size:12px;color:#555">${h.dateStr}</div>
                    </div>
                    <button class="set-btn" onclick="setSpecial('${dIso}')">${i18n[currentLang].setBtn}</button>
                </div>`;
            });
        } catch(e) { list.innerHTML = "Error loading holidays."; }
    }

    async function hToG(d,m,y,nEn,nAr) {
        let r = await fetch(`https://api.aladhan.com/v1/hToG?date=${String(d).padStart(2,'0')}-${String(m).padStart(2,'0')}-${y}`);
        let j = await r.json();
        if(j.code===200) {
            let g = j.data.gregorian;
            return { raw: new Date(g.year, g.month.number-1, g.day), dateStr: g.date, nameEn: nEn, nameAr: nAr };
        }
    }

    function setSpecial(val) {
        document.getElementById(`spec${nextSpecialSlot}`).value = val;
        nextSpecialSlot = (nextSpecialSlot % 4) + 1; 
        calculateAll();
    }

    function generateShortPDF() { createPDF(true); }
    function generateFullPDF() { createPDF(false); }

    function createPDF(isShort) {
        let temp = document.createElement('div');
        temp.style.width = '750px'; temp.style.background = 'white'; temp.style.padding = '20px';
        
        // Use default font for PDF to avoid arabic issues in simple html2pdf usage without custom fonts
        temp.style.fontFamily = 'Arial, sans-serif';

        let calClone = document.getElementById('section-calendar').cloneNode(true);
        calClone.style.flex = 'none'; calClone.style.width = '100%'; calClone.style.boxShadow='none';
        if (isShort) {
            let tbody = calClone.querySelector('tbody');
            while(tbody.children.length > 15) { tbody.removeChild(tbody.lastChild); }
            let title = calClone.querySelector('div');
            title.innerText = currentLang==='ar' ? "ملخص 3 أشهر" : "3-Month Summary";
        }
        temp.appendChild(calClone);

        if (!isShort) {
            let yearClone = document.getElementById('section-yearview').cloneNode(true);
            yearClone.style.boxShadow='none'; yearClone.style.marginTop='20px';
            yearClone.querySelectorAll('button').forEach(b=>b.remove());
            let grid = yearClone.querySelector('.year-grid');
            grid.style.display = 'grid'; grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
            grid.querySelectorAll('.month-block').forEach(b=>{ b.style.width='auto'; b.style.fontSize='10px'; });
            temp.appendChild(yearClone);

            let holClone = document.getElementById('section-holidays').cloneNode(true);
            holClone.style.boxShadow='none'; holClone.style.border='none'; holClone.style.marginTop='20px';
            holClone.querySelectorAll('button').forEach(b=>b.remove());
            temp.appendChild(holClone);
        }

        let overlay = document.createElement('div');
        overlay.style.position='fixed'; overlay.style.top='0'; overlay.style.zIndex='-9999'; overlay.style.opacity='0';
        overlay.appendChild(temp); document.body.appendChild(overlay);

        const opt = {
            margin: 0.2, filename: isShort ? 'Shift_Summary.pdf' : 'Full_Calendar.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(temp).save().then(() => document.body.removeChild(overlay));
    }

    window.onload = init;

</script>
</body>
</html>